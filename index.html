<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Mini JSONBin Interaktif (Dark Mode Refined)</title>
  <style>
    /* === Palet Warna Dark Mode (Mirip Gambar) === */
    :root {
      --bg-color: #24243e; 
      --surface-color: #1e1e2d; 
      --text-color: #e0e0e0;
      --text-secondary: #9aa0a6;
      --border-color: #3b3b5c;
      --primary-color: #7928ca; 
      --primary-hover: #9c45e0;
      --danger-color: #ff4d4f; 
      --padding-unit: 0.75rem;
      --radius: 8px;
      --list-row-bg: #2d2d4f; /* Warna latar belakang baris di daftar */
      --list-row-hover: #3a3a63; /* Warna hover baris */
    }

    /* === BASE & TYPOGRAPHY === */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 1.5rem;
      max-width: 900px;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0 auto; 
    }

    h1 {
      font-size: 1.5rem;
      color: var(--text-color);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: var(--padding-unit);
      margin-bottom: 1.5rem;
    }
    
    label {
        display: block;
        margin-top: 1rem;
        margin-bottom: 0.25rem;
        color: var(--text-secondary);
        font-size: 0.9rem;
        font-weight: 600;
    }

    /* === INPUT & PROJECT NAME === */
    .input-group {
        margin-bottom: 1.5rem;
    }
    #filename, .project-name {
      width: 100%;
      box-sizing: border-box;
      padding: var(--padding-unit);
      border: 1px solid var(--border-color);
      background-color: var(--surface-color);
      color: var(--text-color);
      border-radius: var(--radius);
      margin-top: 0.5rem;
    }

    /* === EDITOR & TABS (sama seperti sebelumnya) === */
    .editor-section {
        margin-bottom: 1.5rem;
    }
    .editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: var(--surface-color);
        padding: 0.5rem var(--padding-unit);
        border-top-left-radius: var(--radius);
        border-top-right-radius: var(--radius);
        border: 1px solid var(--border-color);
        border-bottom: none;
    }
    .editing-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    .tabs button {
        background: none;
        border: none;
        color: var(--text-secondary);
        padding: 0.5rem 1rem;
        margin: 0;
        cursor: pointer;
        font-weight: 500;
        border-radius: 4px;
        transition: color 0.2s;
    }
    .tabs .tab-active {
        color: var(--primary-color);
        background-color: var(--bg-color);
        border: 1px solid var(--border-color);
    }
    .tabs .tab-inactive:hover {
        color: var(--text-color);
    }
    

    #editor {
      width: 100%;
      height: 400px;
      min-height: 250px;
      border: 1px solid var(--border-color);
      font-family: 'Consolas', 'Courier New', monospace;
      padding: var(--padding-unit);
      overflow: auto;
      background-color: var(--surface-color);
      color: var(--text-color);
      border-bottom-left-radius: var(--radius);
      border-bottom-right-radius: var(--radius);
      white-space: pre-wrap;
      line-height: 1.4;
    }
    
    #editor-table {
        background-color: var(--surface-color);
        border: 1px solid var(--border-color);
        border-top: none;
        border-bottom-left-radius: var(--radius);
        border-bottom-right-radius: var(--radius);
        padding: var(--padding-unit);
        overflow-x: auto;
    }
    
    .table-actions {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        justify-content: flex-start;
    }
    .table-actions button {
        background-color: var(--border-color);
        padding: 0.5rem 1rem;
    }
    .table-actions button:hover {
        background-color: #555577;
    }


    /* Tombol Utama (Update & Delete) - sama seperti sebelumnya */
    .main-action-group {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    .main-btn {
        padding: 0.75rem 2rem;
        font-size: 1rem;
    }
    .update-btn {
        background-color: var(--primary-color);
    }
    .update-btn:hover {
        background-color: var(--primary-hover);
    }
    .delete-btn {
        background-color: var(--danger-color);
    }
    .delete-btn:hover {
        opacity: 0.8;
    }

    /* Tombol Sekunder (Create, Read, List) - sama seperti sebelumnya */
    .secondary-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
      justify-content: flex-start;
      border-top: 1px solid var(--border-color);
      padding-top: 1rem;
    }
    .secondary-row button {
        background-color: var(--border-color);
        padding: 0.5rem 1.25rem;
    }
    .secondary-row button:hover {
        background-color: #555577;
    }


    /* === OUTPUT / LIST TABLE STYLES BARU === */
    #out {
      background-color: var(--surface-color);
      padding: 0; /* Hapus padding luar */
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      white-space: pre-wrap;
      max-height: 500px;
      overflow-y: auto;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 0.9rem;
      color: #70a0d0;
    }
    
    #list-table-container {
        padding: 0;
        margin-top: 0;
    }
    
    .list-header {
        font-size: 1.5rem;
        padding: var(--padding-unit);
        border-bottom: 1px solid var(--border-color);
        color: var(--text-color);
    }

    #list-table {
        width: 100%;
        border-collapse: collapse;
    }

    #list-table th {
        background-color: var(--surface-color);
        color: var(--text-secondary);
        text-align: left;
        padding: var(--padding-unit);
        font-weight: 600;
        border-bottom: 1px solid var(--border-color);
        position: sticky; /* Sticky header saat scroll */
        top: 0;
    }

    #list-table td {
        padding: var(--padding-unit);
        border-bottom: 1px solid var(--border-color);
        color: var(--text-color);
    }
    
    #list-table tbody tr {
        background-color: var(--list-row-bg);
        transition: background-color 0.2s;
    }
    #list-table tbody tr:hover {
        background-color: var(--list-row-hover);
    }
    
    /* Kolom Aksi */
    .action-cell {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end; /* Aksi ke kanan */
    }
    
    .action-cell button {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
        font-weight: 500;
    }
    .view-edit-btn {
        background-color: var(--primary-color); /* Warna untuk View & Edit */
    }
    .view-edit-btn:hover {
        background-color: var(--primary-hover);
    }
    .action-cell .delete-btn {
        background-color: var(--danger-color);
    }
    .action-cell .delete-btn:hover {
        opacity: 0.8;
    }

  </style>
</head>
<body>
<h1>Mini JSONBin Interaktif (GitHub Repo via API)</h1>

<!-- Input Project Name/Context -->
<div class="input-group">
    <label>Project Name</label>
    <input type="text" class="project-name" value="json Api github" disabled>
</div>

<!-- Input Nama File -->
<div class="input-group">
    <label for="filename">Nama file (kosong untuk create baru)</label>
    <input id="filename" placeholder="data/bin-123.json">
</div>

<!-- Editor dan Tabs -->
<div class="editor-section">
    <div class="editor-header">
        <span class="editing-label">Editing Bin: (Click Read to load SHA)</span>
        <div class="tabs">
            <button id="tab-raw" class="tab-active" onclick="switchEditorMode('raw')">Raw</button>
            <button id="tab-table" class="tab-inactive" onclick="switchEditorMode('table')">Table</button>
        </div>
    </div>
    
    <!-- Editor Raw (JSON Teks) -->
    <div id="editor-raw">
        <div id="editor" contenteditable="true">{ "hello": "world" }</div>
    </div>

    <!-- Container untuk Tabel (Awalnya tersembunyi) -->
    <div id="editor-table" style="display:none;">
        <div id="table-view" style="padding:0; border: none; border-top: none; border-bottom-left-radius: var(--radius); border-bottom-right-radius: var(--radius); overflow-x: auto;">
            <!-- Actions di dalam Table View -->
            <p style="color:var(--danger-color); font-weight: bold; padding: var(--padding-unit); margin: 0;">PERINGATAN: Edit Tabel. Wajib klik "Raw" sebelum "Update Bin" agar perubahan tersimpan.</p>
            <div class="table-actions" style="padding: 0 var(--padding-unit);">
                <button onclick="addRow()">Tambah Row</button>
                <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem; align-self: center;">(Klik 'Raw' untuk mengedit JSON) </p>
            </div>
        </div>
    </div>
</div>

<!-- Tombol Utama (Update & Delete) -->
<div class="main-action-group">
    <button onclick="updateBin()" class="main-btn update-btn">Update Bin</button>
    <button onclick="deleteBin()" class="main-btn delete-btn">Delete</button>
</div>

<!-- Tombol Sekunder (CRUD lainnya) -->
<div class="secondary-row">
    <button onclick="createBin()">Create Baru</button>
    <button onclick="readBin()">Read</button>
    <button onclick="listBins()">List Semua</button>
</div>

<div id="out">Output log akan muncul di sini...</div>

<script>
let CONFIG;

// DOM elements
const editorElem = document.getElementById('editor');
const editorRawDiv = document.getElementById('editor-raw');
const editorTableDiv = document.getElementById('editor-table');
const tabRawBtn = document.getElementById('tab-raw');
const tabTableBtn = document.getElementById('tab-table');
const tableViewDiv = document.getElementById('table-view');

let currentMode = 'raw';
let currentHeaders = []; 


function log(x, isHtml = false){
    const outElement = document.getElementById('out');
    if (isHtml) {
        // Hapus padding dan terapkan style List Table Container
        outElement.style.padding = '0'; 
        outElement.innerHTML = x;
    } else if (typeof x === 'string') {
        // Kembalikan padding untuk log teks biasa
        outElement.style.padding = '1rem'; 
        outElement.textContent = x;
    } else {
        outElement.style.padding = '1rem'; 
        outElement.textContent = JSON.stringify(x, null, 2);
    }
}

function tryParse(value) {
    if (value === undefined || value === null) return null;
    if (value.toLowerCase() === 'true') return true;
    if (value.toLowerCase() === 'false') return false;
    if (!isNaN(value) && value.trim() !== '') return Number(value);
    return value;
}


// === Fungsi Editor Mode (Tidak diubah, hanya memastikan logika tetap benar) ===
function switchEditorMode(mode) {
    if (mode === currentMode) return;
    if (currentMode === 'table') getTableDataAndReconstructJSON();
    
    if (mode === 'raw') {
        editorRawDiv.style.display = 'block';
        editorTableDiv.style.display = 'none';
        tabRawBtn.classList.add('tab-active');
        tabRawBtn.classList.remove('tab-inactive');
        tabTableBtn.classList.remove('tab-active');
        tabTableBtn.classList.add('tab-inactive');
    } else if (mode === 'table') {
        editorRawDiv.style.display = 'none';
        editorTableDiv.style.display = 'block';
        tabRawBtn.classList.remove('tab-active');
        tabRawBtn.classList.add('tab-inactive');
        tabTableBtn.classList.add('tab-active');
        tabTableBtn.classList.remove('tab-inactive');
        renderEditableTable();
    }
    currentMode = mode;
}

function addRow() { /* Logic sama */ }
function deleteRow(btn) { /* Logic sama */ }
function renderEditableTable() { /* Logic sama */ }
function getTableDataAndReconstructJSON() { /* Logic sama */ }

// --- (Sisipkan kode lengkap fungsi addRow, deleteRow, renderEditableTable, getTableDataAndReconstructJSON dari jawaban sebelumnya di sini) ---
// Note: Karena batasan panjang, saya tidak mengulang semua kode tabel di sini,
// asumsikan fungsi-fungsi tersebut sudah ada di kode Anda, dan kini hanya fungsi listBins yang dirombak.
// --------------------------------------------------------------------------------------------------------------------------------------------------

// Menambahkan Baris ke Tabel
function addRow() {
    if (currentHeaders.length === 0) {
        alert("Tidak bisa menambah baris. Silakan muat data yang merupakan Array Objek terlebih dahulu.");
        return;
    }

    const tableBody = document.querySelector('#data-table tbody');
    if (!tableBody) return;

    let newRowHtml = '<tr>';
    currentHeaders.forEach(h => {
        newRowHtml += `<td data-key="${h}" data-type="string" contenteditable="true"></td>`;
    });
    newRowHtml += `<td><button class="row-delete-btn" onclick="deleteRow(this)">x</button></td></tr>`;

    tableBody.innerHTML += newRowHtml;
}

// Menghapus Baris dari Tabel
function deleteRow(btn) {
    if (!confirm("Hapus baris ini?")) return;
    const row = btn.parentNode.parentNode;
    row.parentNode.removeChild(row);
}

// Fungsi untuk merender Tabel yang dapat di-edit
function renderEditableTable() {
    let data;
    try {
        data = getEditorJSON();
    } catch (e) {
        tableViewDiv.querySelector('p').innerHTML = `<p style="color:var(--danger-color); padding:var(--padding-unit); font-weight: bold;">JSON tidak valid. Tidak dapat menampilkan tabel.</p>`;
        return;
    }

    const isArrayOfObjects = Array.isArray(data) && data.every(item => typeof item === 'object' && item !== null);
    
    // Clear old table but keep the message and buttons
    const message = tableViewDiv.querySelector('p').outerHTML;
    const actions = tableViewDiv.querySelector('.table-actions').outerHTML;
    tableViewDiv.innerHTML = message + actions;
    
    if (isArrayOfObjects) {
        currentHeaders = Array.from(new Set(data.flatMap(Object.keys)));
        
        let tableHtml = `<div style="overflow-x: auto; padding: 0 var(--padding-unit) var(--padding-unit);"><table id="data-table"><thead><tr>`;
        
        // Header
        currentHeaders.forEach(h => {
            tableHtml += `<th>${h}</th>`;
        });
        tableHtml += `<th style="width: 20px;"></th></tr></thead><tbody>`; // Kolom untuk tombol delete

        // Baris data
        data.forEach(item => {
            tableHtml += `<tr>`;
            currentHeaders.forEach(h => {
                let value = item[h] !== undefined ? item[h] : '';
                if (typeof value === 'object' && value !== null) {
                    value = JSON.stringify(value);
                    tableHtml += `<td data-key="${h}" data-type="string">${value}</td>`; // Non-editable
                } else {
                    tableHtml += `<td data-key="${h}" data-type="${typeof value}" contenteditable="true">${value}</td>`;
                }
            });
            tableHtml += `<td><button class="row-delete-btn" onclick="deleteRow(this)">x</button></td></tr>`; 
        });
        
        tableHtml += `</tbody></table></div>`;
        tableViewDiv.innerHTML += tableHtml;
        
    } else if (typeof data === 'object' && data !== null) {
        currentHeaders = Object.keys(data);
        let tableHtml = `<div style="overflow-x: auto; padding: 0 var(--padding-unit) var(--padding-unit);"><table id="data-table" style="width: 50%; min-width: 300px;"><tbody>`;
        
        for (const key in data) {
            let value = data[key];
            if (typeof value === 'object' && value !== null) {
                value = JSON.stringify(value);
                tableHtml += `<tr>
                    <td style="background-color: #33334f; width: 30%; font-weight: bold;">${key}</td>
                    <td>${value}</td>
                </tr>`;
            } else {
                tableHtml += `<tr>
                    <td style="background-color: #33334f; width: 30%; font-weight: bold;">${key}</td>
                    <td data-key="${key}" data-type="${typeof value}" contenteditable="true">${value}</td>
                </tr>`;
            }
        }
        tableHtml += `</tbody></table></div>`;
        tableViewDiv.innerHTML += tableHtml;
        
    } else {
        tableViewDiv.innerHTML += `<p style="padding:var(--padding-unit);">Data harus dalam format Array Objek (contoh: daftar film) atau Objek tunggal untuk ditampilkan dalam tabel.</p>`;
    }
}

// Fungsi untuk membaca data dari tabel dan merekonstruksi JSON
function getTableDataAndReconstructJSON() {
    const table = document.getElementById('data-table');
    if (!table) return;

    const reconstructedData = [];
    
    if (table.querySelector('thead')) {
        const headers = [];
        table.querySelectorAll('thead th').forEach(th => {
            const headerText = th.textContent.trim();
            if (headerText !== '') headers.push(headerText);
        });

        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const rowObject = {};
            const dataCells = row.querySelectorAll('td');
            
            dataCells.forEach((cell, index) => {
                const key = headers[index];
                if (!key) return; 
                
                const value = cell.textContent.trim();
                const isEditable = cell.getAttribute('contenteditable') === 'true';
                
                if (isEditable) {
                    rowObject[key] = tryParse(value);
                } else {
                    try {
                        rowObject[key] = JSON.parse(value); 
                    } catch {
                        rowObject[key] = value; 
                    }
                }
            });
            reconstructedData.push(rowObject);
        });
        setEditorJSON(reconstructedData);

    } else {
        const singleObject = {};
        const rows = table.querySelectorAll('tbody tr');
        
        rows.forEach(row => {
            const keyCell = row.querySelector('td:first-child');
            const valueCell = row.querySelector('td:last-child[contenteditable="true"]');

            if (keyCell && valueCell) {
                const key = keyCell.textContent.trim();
                const value = valueCell.textContent.trim();
                singleObject[key] = tryParse(value);
            }
        });
        setEditorJSON(singleObject);
    }
}


// --- Sisanya (loadConfig, CRUD, dll.) ---

async function loadConfig() {
  try {
    const res = await fetch("https://jsonbin-clone.bisay510.workers.dev/bd9aa0c6-469a-4808-8b5d-31491c30d678");
    CONFIG = await res.json();
    CONFIG.PAGES_URL_BASE = `https://${CONFIG.USERNAME}.github.io/${CONFIG.REPO}/`; 
    log("Config loaded successfully! Ready to use.");
  } catch (e) {
    log("Gagal load config dari API. Periksa konsol untuk detail. Pastikan API URL benar.");
    console.error(e);
  }
}

function headers(){ /* ... */ }
async function api(path,opts){ /* ... */ }
function getEditorJSON(){ try{ return JSON.parse(editorElem.innerText); } catch(e){ alert("JSON invalid"); throw e; } }
function setEditorJSON(obj){ editorElem.innerText=JSON.stringify(obj,null,2); }

async function loadPathToInput(path) {
    if (!CONFIG) return alert("Config belum dimuat. Tunggu sebentar.");
    switchEditorMode('raw');
    document.getElementById('filename').value = path;
    await readBin();
    document.getElementById('out').innerHTML = `<strong>File <span style="color:#88c0d0;">${path}</span> dimuat ke editor. Anda bisa mengedit dan klik 'Update Bin'.</strong>`;
}

async function confirmAndDelete(path) {
    if (!CONFIG) return alert("Config belum dimuat. Tunggu sebentar.");
    if (confirm(`Anda yakin ingin MENGHAPUS file ini: ${path}?`)) {
        document.getElementById('filename').value = path;
        await deleteBin();
        if (document.getElementById('out').textContent.includes('commit')) {
            listBins(); 
        }
    }
}

async function createBin(){
  if (!CONFIG) return alert("Config belum dimuat. Tunggu sebentar.");
  switchEditorMode('raw');
  const data = getEditorJSON();
  const fname = "data/bin-" + Date.now() + ".json";
  const body = {message:"Create bin", content:btoa(JSON.stringify(data,null,2)), branch:CONFIG.BRANCH};
  const res = await api(`/repos/${CONFIG.USERNAME}/${CONFIG.REPO}/contents/${fname}`, {method:"PUT", headers:headers(), body:JSON.stringify(body)});
  
  document.getElementById('filename').value = fname;
  
  if (res.content) {
      const pageUrl = CONFIG.PAGES_URL_BASE + fname;
      log(`Bin created successfully! New File: ${fname}\nLink Akses: ${pageUrl}`, false); 
  } else {
      log(res); 
  }
}

async function readBin(){
  if (!CONFIG) return alert("Config belum dimuat. Tunggu sebentar.");
  switchEditorMode('raw');
  const f = document.getElementById('filename').value.trim();
  if(!f) return alert("Masukkan nama file");
  const res = await api(`/repos/${CONFIG.USERNAME}/${CONFIG.REPO}/contents/${f}?ref=${CONFIG.BRANCH}`, {headers:headers()});
  if(res.content) { setEditorJSON(JSON.parse(atob(res.content))); log(res); } else log(res);
}

async function updateBin(){
  if (!CONFIG) return alert("Config belum dimuat. Tunggu sebentar.");
  switchEditorMode('raw'); 
  const f = document.getElementById('filename').value.trim();
  if(!f) return alert("Masukkan nama file");
  const existing = await api(`/repos/${CONFIG.USERNAME}/${CONFIG.REPO}/contents/${f}?ref=${CONFIG.BRANCH}`, {headers:headers()});
  if(!existing.sha) return log(existing);
  const data = getEditorJSON();
  const body = {message:"Update bin", content:btoa(JSON.stringify(data,null,2)), branch:CONFIG.BRANCH, sha:existing.sha};
  const res = await api(`/repos/${CONFIG.USERNAME}/${CONFIG.REPO}/contents/${f}`, {method:"PUT", headers:headers(), body:JSON.stringify(body)});
  log(res);
}

async function deleteBin(){
  if (!CONFIG) return alert("Config belum dimuat. Tunggu sebentar.");
  switchEditorMode('raw');
  const f = document.getElementById('filename').value.trim();
  if(!f) return alert("Masukkan nama file");
  const existing = await api(`/repos/${CONFIG.USERNAME}/${CONFIG.REPO}/contents/${f}?ref=${CONFIG.BRANCH}`, {headers:headers()});
  if(!existing.sha) return log(existing);
  const body = {message:"Delete bin", sha:existing.sha, branch:CONFIG.BRANCH};
  const res = await api(`/repos/${CONFIG.USERNAME}/${CONFIG.REPO}/contents/${f}`, {method:"DELETE", headers:headers(), body:JSON.stringify(body)});
  log(res);
  if (res.commit) {
      document.getElementById('filename').value = ""; 
  }
}

// === FUNGSI LIST BINS BARU (Menampilkan dalam format tabel) ===
async function listBins(){
  if (!CONFIG) return alert("Config belum dimuat. Tunggu sebentar.");
  switchEditorMode('raw'); 

  const res = await api(`/repos/${CONFIG.USERNAME}/${CONFIG.REPO}/contents/data?ref=${CONFIG.BRANCH}`, {headers:headers()});
  
  if(Array.isArray(res)) {
      let htmlList = `<div id="list-table-container">
                        <div class="list-header">My Bins</div>
                        <table id="list-table">
                          <thead>
                            <tr>
                              <th>PROJECT</th>
                              <th style="width: 20%;">CREATED AT (Approx)</th>
                              <th style="width: 25%; text-align: right;">ACTIONS</th>
                            </tr>
                          </thead>
                          <tbody>`;
      
      const jsonFiles = res.filter(f => f.type === 'file' && f.name.endsWith('.json'));

      if (jsonFiles.length === 0) {
          htmlList += `<tr><td colspan="3" style="text-align: center;">Tidak ada file JSON ditemukan di folder data/.</td></tr>`;
      } else {
          jsonFiles.forEach(f => {
              // Extract timestamp dari nama file (misal: bin-1702123456789.json)
              const match = f.name.match(/(\d+)/);
              let createdDate = 'N/A';
              if (match && match[1]) {
                  const timestamp = parseInt(match[1]);
                  if (!isNaN(timestamp)) {
                      createdDate = new Date(timestamp).toLocaleString();
                  }
              }

              htmlList += `
                <tr>
                    <td>${f.name}</td>
                    <td>${createdDate}</td>
                    <td class="action-cell">
                        <button class="view-edit-btn" onclick="loadPathToInput('${f.path}')">View & Edit</button>
                        <button class="delete-btn" onclick="confirmAndDelete('${f.path}')">Delete</button>
                    </td>
                </tr>
              `;
          });
      }
      
      htmlList += `</tbody></table></div>`;
      log(htmlList, true);
  } else {
      log(res);
  }
}

loadConfig();
</script>
</body>
</html>